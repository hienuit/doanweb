<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Lá»‹ch sá»­ chuyáº¿n Ä‘i</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #e0f7fa, #f1f8e9);
      margin: 0;
      padding: 40px;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #2e7d32;
      margin-bottom: 40px;
    }

    #history-list {
      max-width: 800px;
      margin: 0 auto;
    }

    .history-item {
      background: #ffffff;
      border-left: 6px solid #4caf50;
      padding: 20px 25px;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }

    .history-item:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.1);
    }

    .history-item h3 {
      color: #388e3c;
      margin-top: 0;
    }

    .history-item p {
      margin: 6px 0;
      line-height: 1.6;
    }

    .history-item ul {
      padding-left: 20px;
      margin-top: 6px;
    }

    .history-item ul li {
      margin-bottom: 4px;
      list-style: circle;
    }

    .error {
      color: red;
      text-align: center;
    }

    .loading {
      text-align: center;
      font-style: italic;
      color: #555;
    }
  </style>
</head>
<body>
  <!-- Home Button -->
  <a href="/" class="home-button" style="position: fixed; top: 20px; left: 20px; z-index: 1000; background-color: #2e7d32; color: white; padding: 10px 15px; border-radius: 25px; text-decoration: none; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: all 0.3s ease;">
    <i class="fas fa-home" style="margin-right: 5px;"></i>Trang Chá»§
  </a>
  
  <h1>Lá»‹ch sá»­ chuyáº¿n Ä‘i cá»§a báº¡n</h1>

  <div style="text-align:center; margin-bottom: 20px;">
    <button id="clear-history" style="background-color: #e53935; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
      ğŸ—‘ï¸ XÃ³a toÃ n bá»™ lá»‹ch sá»­
    </button>

    <button id="create-personalized-history" style="background-color: #156e89; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
      ğŸ‘» Táº¡o lá»‹ch sá»­ cÃ¡ nhÃ¢n hÃ³a
    </button>
  </div>
  
  <div id="history-list" class="loading">Äang táº£i dá»¯ liá»‡u...</div>

  <script>
    function formatBudget(val) {
      if (!val) return "KhÃ´ng rÃµ";
      if (!isNaN(val)) return Number(val).toLocaleString() + " VND";

      switch (val) {
        case 'under2m': return 'DÆ°á»›i 2 triá»‡u';
        case '2to5m': return 'Tá»« 2â€“5 triá»‡u';
        case 'over5m': return 'TrÃªn 5 triá»‡u';
        default: return val;
      }
    }

    fetch('/get-history')
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => {
            console.error("Lá»—i tá»« server:", text);
            throw new Error("KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u");
          });
        }
        return response.json();
      })
      .then(data => {
        const container = document.getElementById('history-list');
        container.classList.remove('loading');
        container.innerHTML = '';

        if (!data.histories || data.histories.length === 0) {
          container.innerHTML = '<p style="text-align:center;">ChÆ°a cÃ³ lá»‹ch sá»­ chuyáº¿n Ä‘i nÃ o.</p>';
          return;
        }

        historyJsonArray = []
        data.histories.forEach((item, index) => {


            const historyJson = {
            id: index + 1, // Use item.id if your server provides a unique ID
            destination: item.destination,
            days: item.days,
            total_cost: item.total_cost
          };

          // Add to the array
          historyJsonArray.push(historyJson);

          const activityList = Array.isArray(item.activity_names)
            ? item.activity_names.map(name => `<li>${name}</li>`).join('')
            : '<li>KhÃ´ng cÃ³ Ä‘á»‹a Ä‘iá»ƒm</li>';

          const div = document.createElement('div');
          div.className = 'history-item';
          div.innerHTML = `
            <h3>Chuyáº¿n Ä‘i #${index + 1}</h3>
            <p><strong>ğŸ—ºï¸ Äiá»ƒm Ä‘áº¿n:</strong> ${item.destination}</p>
            <p><strong>ğŸ“… Sá»‘ ngÃ y:</strong> ${item.days} ngÃ y</p>
            <p><strong>ğŸ’° NgÃ¢n sÃ¡ch:</strong> ${formatBudget(item.total_cost)}</p>
            <p><strong>ğŸ“Œ Äá»‹a Ä‘iá»ƒm Ä‘Ã£ chá»n:</strong></p>
            <ul>${activityList}</ul>
            <p><strong>ğŸ•’ NgÃ y lÆ°u:</strong> ${item.created_at}</p>
          `;
        
          container.appendChild(div);
        });
      })
      .catch(err => {
        console.error("Lá»—i khi láº¥y lá»‹ch sá»­:", err);
        const container = document.getElementById('history-list');
        container.classList.remove('loading');
        container.innerHTML = '<p class="error">Lá»—i khi táº£i lá»‹ch sá»­!</p>';
      });


      document.getElementById("clear-history").addEventListener("click", function () {
        if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a toÃ n bá»™ lá»‹ch sá»­ chuyáº¿n Ä‘i?")) return;

        fetch('/delete-history', {
          method: 'DELETE'
        })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            window.location.reload();
          })
          .catch(error => {
            console.error("Lá»—i khi xÃ³a lá»‹ch sá»­:", error);
            alert("ÄÃ£ xáº£y ra lá»—i khi xÃ³a lá»‹ch sá»­!");
          });
      });


      document.getElementById("create-personalized-history").addEventListener("click", function () {
        if (historyJsonArray.length === 0) {
          alert("KhÃ´ng cÃ³ lá»‹ch sá»­ nÃ o Ä‘á»ƒ gá»­i!");
          return;
        }

        fetch('/create-personalized-history', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(historyJsonArray)
        })
          .then(response => {
            if (!response.ok) {
              return response.json().then(data => {
                console.error("Lá»—i tá»« server:", data.error || response.statusText);
                throw new Error(data.error || "KhÃ´ng thá»ƒ gá»­i dá»¯ liá»‡u");
              });
            }
            return response.json(); // Tráº£ vá» JSON response náº¿u thÃ nh cÃ´ng
          })
          .then(data => {
            // Kiá»ƒm tra náº¿u pháº£n há»“i cÃ³ dá»¯ liá»‡u
            if (data.success && data.data) {
              // LÆ°u chá»‰ pháº§n lá»‹ch sá»­ Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ vÃ o localStorage
              localStorage.setItem('personalizedHistory', JSON.stringify(data.data));
              // Chuyá»ƒn hÆ°á»›ng tá»›i trang personalized-history
              window.location.href = '/personalized-history';
            } else {
              
              throw new Error("Pháº£n há»“i khÃ´ng há»£p lá»‡ tá»« server.");
            }
          })
          .catch(error => {
            console.error("Lá»—i khi gá»­i lá»‹ch sá»­ cÃ¡ nhÃ¢n hÃ³a:", error);
            alert("ÄÃ£ xáº£y ra lá»—i khi gá»­i lá»‹ch sá»­ cÃ¡ nhÃ¢n hÃ³a: " + error.message);
          });
      });


  </script>
</body>
</html>
