<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>L·ªãch s·ª≠ chuy·∫øn ƒëi c·ªßa b·∫°n</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #e0f7fa, #f1f8e9);
      margin: 0;
      padding: 40px;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #2e7d32;
      margin-bottom: 40px;
    }

    #history-list {
      max-width: 800px;
      margin: 0 auto;
    }

    .history-item {
      background: #ffffff;
      border-left: 6px solid #4caf50;
      padding: 20px 25px;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }

    .history-item:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.1);
    }

    .history-item h3 {
      color: #388e3c;
      margin-top: 0;
    }

    .history-item p {
      margin: 6px 0;
      line-height: 1.6;
    }

    .history-item ul {
      padding-left: 20px;
      margin-top: 6px;
    }

    .history-item ul li {
      margin-bottom: 4px;
      list-style: circle;
    }

    .error {
      color: red;
      text-align: center;
    }

    .loading {
      text-align: center;
      font-style: italic;
      color: #555;
    }

    .view-detail-btn {
      background: linear-gradient(45deg, #4caf50, #66bb6a);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
    }

    .view-detail-btn:hover {
      background: linear-gradient(45deg, #388e3c, #4caf50);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
    }

    .view-detail-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <!-- Home Button -->
  <a href="/" class="home-button" style="position: fixed; top: 20px; left: 20px; z-index: 1000; background-color: #2e7d32; color: white; padding: 10px 15px; border-radius: 25px; text-decoration: none; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: all 0.3s ease;">
    <i class="fas fa-home" style="margin-right: 5px;"></i>Trang Ch·ªß
  </a>
  
  <h1>L·ªãch s·ª≠ chuy·∫øn ƒëi c·ªßa b·∫°n</h1>

  <div style="text-align:center; margin-bottom: 20px;">
    <button id="clear-history" style="background-color: #e53935; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
      üóëÔ∏è X√≥a to√†n b·ªô l·ªãch s·ª≠
    </button>

    <button id="create-personalized-history" style="background-color: #156e89; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
      üëª T·∫°o l·ªãch s·ª≠ c√° nh√¢n h√≥a
    </button>
  </div>
  
  <div id="history-list" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>

  <script>
    function formatBudget(val) {
      if (!val) return "Kh√¥ng r√µ";
      if (!isNaN(val)) return Number(val).toLocaleString() + " VND";

      switch (val) {
        case 'under2m': return 'D∆∞·ªõi 2 tri·ªáu';
        case '2to5m': return 'T·ª´ 2‚Äì5 tri·ªáu';
        case 'over5m': return 'Tr√™n 5 tri·ªáu';
        default: return val;
      }
    }

    fetch('/get-history')
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => {
            console.error("L·ªói t·ª´ server:", text);
            throw new Error("Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu");
          });
        }
        return response.json();
      })
      .then(data => {
        const container = document.getElementById('history-list');
        container.classList.remove('loading');
        container.innerHTML = '';

        if (!data.histories || data.histories.length === 0) {
          container.innerHTML = '<p style="text-align:center;">Ch∆∞a c√≥ l·ªãch s·ª≠ chuy·∫øn ƒëi n√†o.</p>';
          return;
        }

        historyJsonArray = []
        data.histories.forEach((item, index) => {


            const historyJson = {
            id: index + 1, // Use item.id if your server provides a unique ID
            destination: item.destination,
            days: item.days,
            total_cost: item.total_cost
          };

          // Add to the array
          historyJsonArray.push(historyJson);
          console.log(historyJsonArray);

          const activityList = Array.isArray(item.activity_names)
            ? item.activity_names.map(name => `<li>${name}</li>`).join('')
            : '<li>Kh√¥ng c√≥ ƒë·ªãa ƒëi·ªÉm</li>';

          const div = document.createElement('div');
          div.className = 'history-item';
          div.innerHTML = `
            <h3>Chuy·∫øn ƒëi #${index + 1}</h3>
            <p><strong>üó∫Ô∏è ƒêi·ªÉm ƒë·∫øn:</strong> ${item.destination}</p>
            <p><strong>üìÖ S·ªë ng√†y:</strong> ${item.days} ng√†y</p>
            <p><strong>üí∞ Ng√¢n s√°ch:</strong> ${formatBudget(item.total_cost)}</p>
            <p><strong>üìå ƒê·ªãa ƒëi·ªÉm ƒë√£ ch·ªçn:</strong></p>
            <ul>${activityList}</ul>
            <p><strong>üïí Ng√†y l∆∞u:</strong> ${item.created_at}</p>
            <button class="view-detail-btn" onclick="viewHistoryDetail(${item.id})">
              <i class="fas fa-eye"></i> Xem chi ti·∫øt l·ªãch tr√¨nh
            </button>
          `;
        
          container.appendChild(div);
        });
      })
      .catch(err => {
        console.error("L·ªói khi l·∫•y l·ªãch s·ª≠:", err);
        const container = document.getElementById('history-list');
        container.classList.remove('loading');
        container.innerHTML = '<p class="error">L·ªói khi t·∫£i l·ªãch s·ª≠!</p>';
      });


      document.getElementById("clear-history").addEventListener("click", function () {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ chuy·∫øn ƒëi?")) return;

        fetch('/delete-history', {
          method: 'DELETE'
        })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            window.location.reload();
          })
          .catch(error => {
            console.error("L·ªói khi x√≥a l·ªãch s·ª≠:", error);
            alert("ƒê√£ x·∫£y ra l·ªói khi x√≥a l·ªãch s·ª≠!");
          });
      });


      function viewHistoryDetail(historyId) {
        // L∆∞u historyId v√†o localStorage ƒë·ªÉ backend c√≥ th·ªÉ s·ª≠ d·ª•ng
        localStorage.setItem('selectedHistoryId', historyId);
        
        // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang xem l·ªãch tr√¨nh t·ª´ l·ªãch s·ª≠
        window.location.href = `/schedule-from-history/${historyId}`;
      }

      // document.getElementById("create-personalized-history").addEventListener("click", function () {
      //   if (historyJsonArray.length === 0) {
      //     alert("Kh√¥ng c√≥ l·ªãch s·ª≠ n√†o ƒë·ªÉ g·ª≠i!");
      //     return;
      //   }
      // });

        
      // fetch('/create-personalized-history', {
      //     method: 'POST',
      //     headers: {
      //       'Content-Type': 'application/json'
      //     },
      //     body: JSON.stringify(historyJsonArray)
      //   })
      //     .then(response => {
      //       if (!response.ok) {
      //         return response.json().then(data => {
      //           console.error("L·ªói t·ª´ server:", data.error || response.statusText);
      //           throw new Error(data.error || "Kh√¥ng th·ªÉ g·ª≠i d·ªØ li·ªáu");
      //         });
      //       }
      //       return response.json(); // Tr·∫£ v·ªÅ JSON response n·∫øu th√†nh c√¥ng
      //     })
      //     .then(data => {
      //       // Ki·ªÉm tra n·∫øu ph·∫£n h·ªìi c√≥ d·ªØ li·ªáu
      //       if (data.success && data.data) {
      //         // L∆∞u ch·ªâ ph·∫ßn l·ªãch s·ª≠ ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω v√†o localStorage
      //         localStorage.setItem('personalizedHistory', JSON.stringify(data.data));
      //         // Chuy·ªÉn h∆∞·ªõng t·ªõi trang personalized-history
      //         window.location.href = '/personalized-history';
      //       } else {
              
      //         throw new Error("Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ server.");
      //       }
      //     })
      //     .catch(error => {
      //       console.error("L·ªói khi g·ª≠i l·ªãch s·ª≠ c√° nh√¢n h√≥a:", error);
      //       alert("ƒê√£ x·∫£y ra l·ªói khi g·ª≠i l·ªãch s·ª≠ c√° nh√¢n h√≥a: " + error.message);
      //     });
          


          // document.getElementById("create-personalized-history").addEventListener("click", function () {
          //     if (historyJsonArray.length === 0) {
          //       alert("Kh√¥ng c√≥ l·ªãch s·ª≠ n√†o ƒë·ªÉ g·ª≠i!");
          //       return;
          //     }

          //     fetch('/create-personalized-history', {
          //       method: 'POST',
          //       headers: {
          //         'Content-Type': 'application/json'
          //       },
          //       body: JSON.stringify(historyJsonArray)
          //     })
          //     .then(response => {
          //       if (!response.ok) {
          //         return response.json().then(data => {
          //           console.error("L·ªói t·ª´ server:", data.error || response.statusText);
          //           throw new Error(data.error || "Kh√¥ng th·ªÉ g·ª≠i d·ªØ li·ªáu");
          //         });
          //       }
          //       return response.json(); // Tr·∫£ v·ªÅ JSON response n·∫øu th√†nh c√¥ng
          //     })
          //     .then(data => {
          //       if (data.success && data.data) {
          //         localStorage.setItem('personalizedHistory', JSON.stringify(data.data));
          //         window.location.href = '/personalized-history';
          //       } else {
          //         throw new Error("Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ server.");
          //       }
          //     })
          //     .catch(error => {
          //       console.error("L·ªói khi g·ª≠i l·ªãch s·ª≠ c√° nh√¢n h√≥a:", error);
          //       alert("ƒê√£ x·∫£y ra l·ªói khi g·ª≠i l·ªãch s·ª≠ c√° nh√¢n h√≥a: " + error.message);
          //     });
          //   });



  </script>
</body>
</html>
